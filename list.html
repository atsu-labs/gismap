<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMLãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ¼ã‚µãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .input-section {
            padding: 30px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .url-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .load-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }
        
        .load-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .load-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .example-urls {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .example-urls h3 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .example-link {
            display: inline-block;
            margin: 5px 10px 5px 0;
            color: #667eea;
            text-decoration: none;
            font-size: 0.9em;
            cursor: pointer;
        }
        
        .example-link:hover {
            text-decoration: underline;
        }
        
        .results {
            padding: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .placemark-list {
            display: grid;
            gap: 15px;
        }
        
        .placemark-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .placemark-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .placemark-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .placemark-description {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .placemark-coords {
            background: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            color: #764ba2;
        }
        
        .coords-label {
            font-weight: bold;
            margin-right: 5px;
        }
        
        .error {
            background: #fee;
            border-left: 4px solid #f44;
            padding: 20px;
            border-radius: 8px;
            color: #c33;
            margin: 20px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç½å®³å—æ´æ‹ ç‚¹ä¸€è¦§</h1>
            <p>æ‹ ç‚¹ã®ä¸€è¦§ã‚’è¡¨ç¤º</p>
        </div>
        
        <div class="input-section">
            <div style="margin-top:16px; display:flex; gap:10px;">
                <button class="load-button" id="refreshButton" style="background:#5a5a5a">ãƒªã‚¹ãƒˆæ›´æ–°</button>
            </div>

            <div class="example-urls" style="margin-top:12px;">
                <h3>æ‹ ç‚¹ä¸€è¦§</h3>
                <div id="fileList"></div>
            </div>
        </div>
        
        <div class="results" id="results">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸŒ</div>
                <p>KMLãƒ•ã‚¡ã‚¤ãƒ«ã®URLã‚’å…¥åŠ›ã—ã¦ã€Œèª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
            </div>
        </div>
    </div>

    <script>
        // kml ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆãƒªãƒã‚¸ãƒˆãƒªã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ—æŒ™ã—ã¦ã„ã¾ã™ï¼‰
        const directoryFiles = [
            'ãƒ˜ãƒªé›¢ç™ºç€.kml',
            'å‰é€²æ‹ ç‚¹.kml',
            'åŒ»ç™‚æ©Ÿé–¢.kml',
            'åœ°ä¸Šå¼.kml',
            'åœ°ä¸‹å¼.kml',
            'å®¿å–¶å¯èƒ½åœ°.kml',
            'æ‹ ç‚¹ã€åœ°ä¸Šéƒ¨éšŠã€‘.kml',
            'æ‹ ç‚¹ã€èˆªç©ºéƒ¨éšŠã€‘.kml',
            'çµ¦æ²¹ã€åœ°ä¸Šéƒ¨éšŠã€‘.kml',
            'çµ¦æ²¹ã€èˆªç©ºéƒ¨éšŠã€‘.kml',
            'é˜²ç«æ°´æ§½.kml'
        ];

        // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        const excludedKeywords = ['åœ°ä¸Šå¼', 'åœ°ä¸‹å¼', 'é˜²ç«æ°´æ§½'];

        const results = document.getElementById('results');
        const fileListEl = document.getElementById('fileList');
        const loadAllButton = document.getElementById('loadAllButton');
        const refreshButton = document.getElementById('refreshButton');

        function buildFileList() {
            // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã¾ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’è¿”ã™
            return directoryFiles.filter(name => !excludedKeywords.some(k => name.includes(k)));
        }

        function renderFileList() {
            const files = buildFileList();
            if (files.length === 0) {
                fileListEl.innerHTML = '<div>å¯¾è±¡ã®KMLãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>';
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨æŠ˜ã‚Šç•³ã¿é ˜åŸŸã‚’æº–å‚™
            fileListEl.innerHTML = files.map(f => `
                <div class="file-section" id="file-${cssId(f)}" style="margin-bottom:10px; border-radius:6px;">
                    <div class="file-header" id="header-${cssId(f)}" style="padding:8px 12px; background:#fff; border:1px solid #e6e6e6; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                        <div style="font-weight:600">${escapeHtml(f)}</div>
                        <div id="status-${cssId(f)}" style="font-size:0.9em; color:#666">æœªèª­ã¿è¾¼ã¿</div>
                    </div>
                    <div class="file-content" id="content-${cssId(f)}" style="display:none; padding:12px; background:#fbfbfb; border:1px solid #efefef; border-top:none;"></div>
                </div>
            `).join('');

            // æŠ˜ã‚Šç•³ã¿ã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã§å‡¦ç†ã—ã¾ã™ï¼ˆå€‹åˆ¥ãƒªã‚¹ãƒŠãƒ¼ã®ä¸Šæ›¸ãã‚’é˜²ããŸã‚ï¼‰
        }

        async function loadAndParseFiles(files) {
            showLoading();

            // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
            fileListEl.innerHTML = files.map(f => `
                <div class="file-section" id="file-${cssId(f)}" style="margin-bottom:10px; border-radius:6px;">
                    <div class="file-header" id="header-${cssId(f)}" style="padding:8px 12px; background:#fff; border:1px solid #e6e6e6; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                        <div style="font-weight:600">${escapeHtml(f)}</div>
                        <div id="status-${cssId(f)}" style="font-size:0.9em; color:#666">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
                    </div>
                    <div class="file-content" id="content-${cssId(f)}" style="display:none; padding:12px; background:#fbfbfb; border:1px solid #efefef; border-top:none;"></div>
                </div>
            `).join('');

            // æŠ˜ã‚Šç•³ã¿ã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã§å‡¦ç†ã—ã¾ã™ï¼ˆinnerHTML ã‚’ä¸Šæ›¸ãã—ã¦ã‚‚å•é¡Œã«ãªã‚‰ãªã„ï¼‰

            // fetch ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¿½åŠ ã—ã¦ç„¡é™å¾…ã¡ã‚’é˜²ã
            // options ã¯ fetch ã«æ¸¡ã™ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆcache ãªã©ï¼‰ã‚’é€éã—ã¾ã™
            const fetchWithTimeout = (resource, options = {}) => {
                const { timeout = 10000, ...fetchOptions } = options;
                const controller = new AbortController();
                fetchOptions.signal = controller.signal;
                const id = setTimeout(() => controller.abort(), timeout);
                return fetch(resource, fetchOptions).finally(() => clearTimeout(id));
            };

            for (const fileName of files) {
                const url = `./kml/${encodeURIComponent(fileName)}`;
                const statusEl = document.getElementById(`status-${cssId(fileName)}`);
                const contentEl = document.getElementById(`content-${cssId(fileName)}`);
                try {
                    let res = await fetchWithTimeout(url, { timeout: 10000 });
                    if (!res) throw new Error('fetch failed');

                    // 304 ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹æœªæ›´æ–°å¿œç­”ãªã®ã§ã‚¨ãƒ©ãƒ¼æ‰±ã„ã«ã—ãªã„
                    if (res.status === 304) {
                        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å„ªå…ˆã§å†å–å¾—ã—ã¦ãƒœãƒ‡ã‚£ã‚’å¾—ã‚‰ã‚Œã‚‹ã‹è©¦ã™
                        try {
                            const cached = await fetchWithTimeout(url, { timeout: 10000, cache: 'force-cache' });
                            if (cached && cached.ok) {
                                res = cached;
                            } else {
                                // æœ€çµ‚æ‰‹æ®µã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã‚’ä½¿ã£ã¦å†å–å¾—
                                res = await fetchWithTimeout(url + (url.includes('?') ? '&' : '?') + `_=${Date.now()}`, { timeout: 10000 });
                            }
                        } catch (e) {
                            // ã©ã®ã¿ã¡ proceed and let later check handle it
                        }
                    }

                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const text = await res.text();
                    const data = parseKMLText(text, fileName);
                    statusEl.innerText = `èª­ã¿è¾¼ã¿æˆåŠŸ (${data.length} ä»¶)`;
                    renderFileSection(contentEl, data);
                } catch (err) {
                    const msg = err.name === 'AbortError' ? 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ' : err.message || String(err);
                    if (statusEl) statusEl.innerText = `ã‚¨ãƒ©ãƒ¼: ${msg}`;
                    if (contentEl) contentEl.innerHTML = `<div class="error" style="margin:6px 0;">${escapeHtml(msg)}</div>`;
                    // ç¶šè¡Œã—ã¦æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
                }
            }

            // å…¨ä½“ã®ç°¡å˜ãªçµ±è¨ˆã‚’ãƒˆãƒƒãƒ—ã«è¡¨ç¤º
            const allPlacemarks = Array.from(document.querySelectorAll('.placemark-item')).length;
            const headerStats = `
                <div class="stats" style="margin-bottom:16px;">
                    <div class="stat-card" style="display:inline-block; margin-right:12px; padding:10px 14px; border-radius:8px; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff;">
                        <div class="stat-number">${allPlacemarks}</div>
                        <div class="stat-label">åˆè¨ˆãƒ—ãƒ¬ã‚¤ã‚¹ãƒãƒ¼ã‚¯</div>
                    </div>
                </div>
            `;
            // replace results area withçµ±è¨ˆãƒ˜ãƒƒãƒ€ï¼ˆèª­ã¿è¾¼ã¿ä¸­ã‚¹ãƒ”ãƒŠãƒ¼ã‚’æ®‹ã•ãªã„ï¼‰
            results.innerHTML = headerStats;
        }

        // å®‰å®šã—ãŸçŸ­ã„IDã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ä½œã‚‹ï¼ˆHTML id ã¨ã—ã¦å®‰å…¨ï¼‰
        function cssId(name) {
            // djb2 ãƒãƒƒã‚·ãƒ¥ã§ä¸€æ„ãªæ•°å€¤ã‚’ä½œã‚‹
            let h = 5381;
            for (let i = 0; i < name.length; i++) {
                h = ((h << 5) + h) + name.charCodeAt(i);
                h = h & 0xFFFFFFFF; // 32bit
            }
            return 'f_' + (h >>> 0).toString(36);
        }

        function parseKMLText(kmlText, sourceFile) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(kmlText, 'text/xml');
            const parserError = xmlDoc.querySelector('parsererror');
            if (parserError) throw new Error('KMLã®è§£æã‚¨ãƒ©ãƒ¼');

            const placemarks = xmlDoc.getElementsByTagName('Placemark');
            const data = [];

            for (let i = 0; i < placemarks.length; i++) {
                const pm = placemarks[i];
                const name = getElementText(pm, 'name') || `ãƒ—ãƒ¬ã‚¤ã‚¹ãƒãƒ¼ã‚¯ ${i + 1}`;
                const description = getElementText(pm, 'description') || '';
                const coordinates = getCoordinates(pm);
                data.push({ name, description, coordinates, source: sourceFile });
            }

            return data;
        }

        function getElementText(parent, tagName) {
            const element = parent.getElementsByTagName(tagName)[0];
            return element ? element.textContent.trim() : '';
        }

        function getCoordinates(placemark) {
            const coordsElement = placemark.getElementsByTagName('coordinates')[0];
            if (!coordsElement) return null;
            const coordsText = coordsElement.textContent.trim();
            // coordinates ã¯è¤‡æ•°åº§æ¨™ã‚’æŒã¤å ´åˆãŒã‚ã‚‹ãŒã€ã“ã“ã§ã¯å…ˆé ­ã®åº§æ¨™ã‚’ä½¿ç”¨
            const first = coordsText.split(/\s+/)[0];
            const parts = first.split(',');
            if (parts.length >= 2) {
                return {
                    longitude: parseFloat(parts[0]),
                    latitude: parseFloat(parts[1]),
                    altitude: parts[2] ? parseFloat(parts[2]) : null
                };
            }
            return null;
        }

        function renderFileSection(containerEl, data) {
            if (!containerEl) return;
            if (data.length === 0) {
                containerEl.innerHTML = '<div class="empty-state" style="padding:8px; color:#777">ãƒ—ãƒ¬ã‚¤ã‚¹ãƒãƒ¼ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const html = data.map(pm => `
                <div class="placemark-item" style="margin-bottom:8px;">
                    <div class="placemark-name">${escapeHtml(pm.name)}</div>
                    ${pm.description ? `<div class="placemark-description">${escapeHtml(pm.description)}</div>` : ''}
                    ${pm.coordinates ? `
                        <div class="placemark-coords">
                            <span class="coords-label">ç·¯åº¦:</span>${pm.coordinates.latitude.toFixed(6)}
                            <span class="coords-label">çµŒåº¦:</span>${pm.coordinates.longitude.toFixed(6)}
                            ${pm.coordinates.altitude !== null ? `<span class="coords-label">æ¨™é«˜:</span>${pm.coordinates.altitude.toFixed(2)}m` : ''}
                        </div>
                    ` : '<div class="placemark-coords">åº§æ¨™ãªã—</div>'}
                </div>
            `).join('');

            containerEl.innerHTML = html;
        }

        function showLoading() {
            results.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            `;
        }

        function showError(message) {
            results.innerHTML = `<div class="error"><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${escapeHtml(message)}</div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆæœŸè¡¨ç¤º
        renderFileList();

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³: fileList ã®ã‚¯ãƒªãƒƒã‚¯ã‚’æ•ã¾ãˆã¦ã€.file-header ã‚’èµ·ç‚¹ã«æŠ˜ã‚Šç•³ã¿ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        fileListEl.addEventListener('click', (e) => {
            const header = e.target.closest('.file-header');
            if (!header) return;
            // header ã® id ã¯ header-<id>ã€å¯¾å¿œã™ã‚‹ content ã® id ã¯ content-<id>
            const headerId = header.id;
            if (!headerId || !headerId.startsWith('header-')) return;
            const contentId = 'content-' + headerId.slice('header-'.length);
            const contentEl = document.getElementById(contentId);
            if (!contentEl) return;
            const isHidden = contentEl.style.display === 'none' || contentEl.style.display === '';
            contentEl.style.display = isHidden ? 'block' : 'none';
        });

        // è‡ªå‹•èª­ã¿è¾¼ã¿ï¼ˆãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ï¼‰
        window.addEventListener('DOMContentLoaded', () => {
            const files = buildFileList();
            if (files.length > 0) {
                loadAndParseFiles(files);
            } else {
                results.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸŒ</div><p>èª­ã¿è¾¼ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>`;
            }
        });

        // æ‰‹å‹•æ“ä½œ
        loadAllButton.addEventListener('click', () => {
            const files = buildFileList();
            if (files.length === 0) {
                showError('èª­ã¿è¾¼ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            loadAndParseFiles(files);
        });

        refreshButton.addEventListener('click', () => {
            renderFileList();
            results.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸŒ</div><p>ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚è‡ªå‹•èª­ã¿è¾¼ã¿ã‚’å†å®Ÿè¡Œã—ã¾ã™ã€‚</p></div>`;
            const files = buildFileList();
            if (files.length > 0) loadAndParseFiles(files);
        });
    </script>
</body>
</html>
