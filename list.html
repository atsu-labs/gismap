<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KML„Éï„Ç°„Ç§„É´„Éë„Éº„Çµ„Éº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .input-section {
            padding: 30px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .url-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .load-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }
        
        .load-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .load-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .example-urls {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .example-urls h3 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .example-link {
            display: inline-block;
            margin: 5px 10px 5px 0;
            color: #667eea;
            text-decoration: none;
            font-size: 0.9em;
            cursor: pointer;
        }
        
        .example-link:hover {
            text-decoration: underline;
        }
        
        .results {
            padding: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .placemark-list {
            display: grid;
            gap: 15px;
        }
        
        .placemark-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .placemark-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .placemark-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .placemark-description {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .placemark-coords {
            background: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            color: #764ba2;
        }
        
        .coords-label {
            font-weight: bold;
            margin-right: 5px;
        }
        
        .error {
            background: #fee;
            border-left: 4px solid #f44;
            padding: 20px;
            border-radius: 8px;
            color: #c33;
            margin: 20px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ÁÅΩÂÆ≥ÂèóÊè¥Êã†ÁÇπ‰∏ÄË¶ß</h1>
            <p>Êã†ÁÇπ„ÅÆ‰∏ÄË¶ß„ÇíË°®Á§∫</p>
        </div>
        
        <div class="input-section">
            <div style="margin-top:16px; display:flex; gap:10px;">
                <button class="load-button" id="refreshButton" style="background:#5a5a5a">„É™„Çπ„ÉàÊõ¥Êñ∞</button>
            </div>

            <div class="example-urls" style="margin-top:12px;">
                <h3>Êã†ÁÇπ‰∏ÄË¶ß</h3>
                <div id="fileList"></div>
            </div>
        </div>
        
        <div class="results" id="results">
            <div class="empty-state">
                <div class="empty-state-icon">üåê</div>
                <p>KML„Éï„Ç°„Ç§„É´„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„ÄåË™≠„ÅøËæº„Åø„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>
        </div>
    </div>

    <script>
        // kml „Éá„Ç£„É¨„ÇØ„Éà„É™ÂÜÖ„ÅÆ„Éï„Ç°„Ç§„É´‰∏ÄË¶ßÔºà„É™„Éù„Ç∏„Éà„É™„Å´Â≠òÂú®„Åô„Çã„Éï„Ç°„Ç§„É´„ÇíÂàóÊåô„Åó„Å¶„ÅÑ„Åæ„ÅôÔºâ
        const directoryFiles = [
            '„Éò„É™Èõ¢Áô∫ÁùÄ.kml',
            'ÂâçÈÄ≤Êã†ÁÇπ.kml',
            'ÂåªÁôÇÊ©üÈñ¢.kml',
            'Âú∞‰∏äÂºè.kml',
            'Âú∞‰∏ãÂºè.kml',
            'ÂÆøÂñ∂ÂèØËÉΩÂú∞.kml',
            'Êã†ÁÇπ„ÄêÂú∞‰∏äÈÉ®Èöä„Äë.kml',
            'Êã†ÁÇπ„ÄêËà™Á©∫ÈÉ®Èöä„Äë.kml',
            'Áµ¶Ê≤π„ÄêÂú∞‰∏äÈÉ®Èöä„Äë.kml',
            'Áµ¶Ê≤π„ÄêËà™Á©∫ÈÉ®Èöä„Äë.kml',
            'Èò≤ÁÅ´Ê∞¥ÊßΩ.kml'
        ];

        // Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„Éâ
        const excludedKeywords = ['Âú∞‰∏äÂºè', 'Âú∞‰∏ãÂºè', 'Èò≤ÁÅ´Ê∞¥ÊßΩ'];

        const results = document.getElementById('results');
        const fileListEl = document.getElementById('fileList');
        const loadAllButton = document.getElementById('loadAllButton');
        const refreshButton = document.getElementById('refreshButton');

        function buildFileList() {
            // Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂê´„Åæ„Å™„ÅÑ„Éï„Ç°„Ç§„É´„ÅÆ„Åø„ÇíËøî„Åô
            return directoryFiles.filter(name => !excludedKeywords.some(k => name.includes(k)));
        }

        function renderFileList() {
            const files = buildFileList();
            if (files.length === 0) {
                fileListEl.innerHTML = '<div>ÂØæË±°„ÅÆKML„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ</div>';
                return;
            }

            // „Éï„Ç°„Ç§„É´„Åî„Å®„Å´„Çπ„ÉÜ„Éº„Çø„Çπ„Å®Êäò„ÇäÁï≥„ÅøÈ†òÂüü„ÇíÊ∫ñÂÇô
            fileListEl.innerHTML = files.map(f => `
                <div class="file-section" id="file-${cssId(f)}" style="margin-bottom:10px; border-radius:6px;">
                    <div class="file-header" id="header-${cssId(f)}" style="padding:8px 12px; background:#fff; border:1px solid #e6e6e6; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                        <div style="font-weight:600">${escapeHtml(f)}</div>
                        <div id="status-${cssId(f)}" style="font-size:0.9em; color:#666">Êú™Ë™≠„ÅøËæº„Åø</div>
                    </div>
                    <div class="file-content" id="content-${cssId(f)}" style="display:none; padding:12px; background:#fbfbfb; border:1px solid #efefef; border-top:none;"></div>
                </div>
            `).join('');

            // Êäò„ÇäÁï≥„Åø„ÅØ„Ç§„Éô„É≥„Éà„Éá„É™„Ç≤„Éº„Ç∑„Éß„É≥„ÅßÂá¶ÁêÜ„Åó„Åæ„ÅôÔºàÂÄãÂà•„É™„Çπ„Éä„Éº„ÅÆ‰∏äÊõ∏„Åç„ÇíÈò≤„Åê„Åü„ÇÅÔºâ
        }

        async function loadAndParseFiles(files) {
            showLoading();

            // ÂàùÊúü„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
            fileListEl.innerHTML = files.map(f => `
                <div class="file-section" id="file-${cssId(f)}" style="margin-bottom:10px; border-radius:6px;">
                    <div class="file-header" id="header-${cssId(f)}" style="padding:8px 12px; background:#fff; border:1px solid #e6e6e6; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                        <div style="font-weight:600">${escapeHtml(f)}</div>
                        <div id="status-${cssId(f)}" style="font-size:0.9em; color:#666">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</div>
                    </div>
                    <div class="file-content" id="content-${cssId(f)}" style="display:none; padding:12px; background:#fbfbfb; border:1px solid #efefef; border-top:none;"></div>
                </div>
            `).join('');

            // Êäò„ÇäÁï≥„Åø„ÅØ„Ç§„Éô„É≥„Éà„Éá„É™„Ç≤„Éº„Ç∑„Éß„É≥„ÅßÂá¶ÁêÜ„Åó„Åæ„ÅôÔºàinnerHTML „Çí‰∏äÊõ∏„Åç„Åó„Å¶„ÇÇÂïèÈ°å„Å´„Å™„Çâ„Å™„ÅÑÔºâ

            // fetch „Å´„Çø„Ç§„É†„Ç¢„Ç¶„Éà„ÇíËøΩÂä†„Åó„Å¶ÁÑ°ÈôêÂæÖ„Å°„ÇíÈò≤„Åê
            // options „ÅØ fetch „Å´Ê∏°„Åô„Ç™„Éó„Ç∑„Éß„É≥Ôºàcache „Å™„Å©Ôºâ„ÇíÈÄèÈÅé„Åó„Åæ„Åô
            const fetchWithTimeout = (resource, options = {}) => {
                const { timeout = 10000, ...fetchOptions } = options;
                const controller = new AbortController();
                fetchOptions.signal = controller.signal;
                const id = setTimeout(() => controller.abort(), timeout);
                return fetch(resource, fetchOptions).finally(() => clearTimeout(id));
            };

            for (const fileName of files) {
                const url = `./kml/${encodeURIComponent(fileName)}`;
                const statusEl = document.getElementById(`status-${cssId(fileName)}`);
                const contentEl = document.getElementById(`content-${cssId(fileName)}`);
                try {
                    let res = await fetchWithTimeout(url, { timeout: 10000 });
                    if (!res) throw new Error('fetch failed');

                    // 304 „ÅØ„Ç≠„É£„ÉÉ„Ç∑„É•„Å´„Çà„ÇãÊú™Êõ¥Êñ∞ÂøúÁ≠î„Å™„ÅÆ„Åß„Ç®„É©„ÉºÊâ±„ÅÑ„Å´„Åó„Å™„ÅÑ
                    if (res.status === 304) {
                        // „Ç≠„É£„ÉÉ„Ç∑„É•ÂÑ™ÂÖà„ÅßÂÜçÂèñÂæó„Åó„Å¶„Éú„Éá„Ç£„ÇíÂæó„Çâ„Çå„Çã„ÅãË©¶„Åô
                        try {
                            const cached = await fetchWithTimeout(url, { timeout: 10000, cache: 'force-cache' });
                            if (cached && cached.ok) {
                                res = cached;
                            } else {
                                // ÊúÄÁµÇÊâãÊÆµ„Åß„Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„Çí‰Ωø„Å£„Å¶ÂÜçÂèñÂæó
                                res = await fetchWithTimeout(url + (url.includes('?') ? '&' : '?') + `_=${Date.now()}`, { timeout: 10000 });
                            }
                        } catch (e) {
                            // „Å©„ÅÆ„Åø„Å° proceed and let later check handle it
                        }
                    }

                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const text = await res.text();
                    const data = parseKMLText(text, fileName);
                    statusEl.innerText = `Ë™≠„ÅøËæº„ÅøÊàêÂäü (${data.length} ‰ª∂)`;
                    renderFileSection(contentEl, data);
                } catch (err) {
                    const msg = err.name === 'AbortError' ? '„Çø„Ç§„É†„Ç¢„Ç¶„Éà' : err.message || String(err);
                    if (statusEl) statusEl.innerText = `„Ç®„É©„Éº: ${msg}`;
                    if (contentEl) contentEl.innerHTML = `<div class="error" style="margin:6px 0;">${escapeHtml(msg)}</div>`;
                    // Á∂öË°å„Åó„Å¶Ê¨°„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂá¶ÁêÜ
                }
            }

            // ÂÖ®‰Ωì„ÅÆÁ∞°Âçò„Å™Áµ±Ë®à„Çí„Éà„ÉÉ„Éó„Å´Ë°®Á§∫
            const allPlacemarks = Array.from(document.querySelectorAll('.placemark-item')).length;
            const headerStats = `
                <div class="stats" style="margin-bottom:16px;">
                    <div class="stat-card" style="display:inline-block; margin-right:12px; padding:10px 14px; border-radius:8px; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff;">
                        <div class="stat-number">${allPlacemarks}</div>
                        <div class="stat-label">ÂêàË®à„Éó„É¨„Ç§„Çπ„Éû„Éº„ÇØ</div>
                    </div>
                </div>
            `;
            // replace results area withÁµ±Ë®à„Éò„ÉÉ„ÉÄÔºàË™≠„ÅøËæº„Åø‰∏≠„Çπ„Éî„Éä„Éº„ÇíÊÆã„Åï„Å™„ÅÑÔºâ
            results.innerHTML = headerStats;
        }

        // ÂÆâÂÆö„Åó„ÅüÁü≠„ÅÑID„Çí„Éï„Ç°„Ç§„É´Âêç„Åã„Çâ‰Ωú„ÇãÔºàHTML id „Å®„Åó„Å¶ÂÆâÂÖ®Ôºâ
        function cssId(name) {
            // djb2 „Éè„ÉÉ„Ç∑„É•„Åß‰∏ÄÊÑè„Å™Êï∞ÂÄ§„Çí‰Ωú„Çã
            let h = 5381;
            for (let i = 0; i < name.length; i++) {
                h = ((h << 5) + h) + name.charCodeAt(i);
                h = h & 0xFFFFFFFF; // 32bit
            }
            return 'f_' + (h >>> 0).toString(36);
        }

        function parseKMLText(kmlText, sourceFile) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(kmlText, 'text/xml');
            const parserError = xmlDoc.querySelector('parsererror');
            if (parserError) throw new Error('KML„ÅÆËß£Êûê„Ç®„É©„Éº');

            const placemarks = xmlDoc.getElementsByTagName('Placemark');
            const data = [];

            for (let i = 0; i < placemarks.length; i++) {
                const pm = placemarks[i];
                const name = getElementText(pm, 'name') || `„Éó„É¨„Ç§„Çπ„Éû„Éº„ÇØ ${i + 1}`;
                const description = getElementText(pm, 'description') || '';
                const coordinates = getCoordinates(pm);
                data.push({ name, description, coordinates, source: sourceFile });
            }

            return data;
        }

        function getElementText(parent, tagName) {
            const element = parent.getElementsByTagName(tagName)[0];
            return element ? element.textContent.trim() : '';
        }

        function getCoordinates(placemark) {
            const coordsElement = placemark.getElementsByTagName('coordinates')[0];
            if (!coordsElement) return null;
            const coordsText = coordsElement.textContent.trim();
            // coordinates „ÅØË§áÊï∞Â∫ßÊ®ô„ÇíÊåÅ„Å§Â†¥Âêà„Åå„ÅÇ„Çã„Åå„ÄÅ„Åì„Åì„Åß„ÅØÂÖàÈ†≠„ÅÆÂ∫ßÊ®ô„Çí‰ΩøÁî®
            const first = coordsText.split(/\s+/)[0];
            const parts = first.split(',');
            if (parts.length >= 2) {
                return {
                    longitude: parseFloat(parts[0]),
                    latitude: parseFloat(parts[1]),
                    altitude: parts[2] ? parseFloat(parts[2]) : null
                };
            }
            return null;
        }

        function renderFileSection(containerEl, data) {
            if (!containerEl) return;
            if (data.length === 0) {
                containerEl.innerHTML = '<div class="empty-state" style="padding:8px; color:#777">„Éó„É¨„Ç§„Çπ„Éû„Éº„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            const html = data.map(pm => `
                <div class="placemark-item" style="margin-bottom:8px;">
                    <div class="placemark-name">${escapeHtml(pm.name)}</div>
                    ${pm.description ? `<div class="placemark-description">${escapeHtml(pm.description)}</div>` : ''}
                    ${pm.coordinates ? `
                        <div class="placemark-coords">
                            <span class="coords-label">Á∑ØÂ∫¶:</span>${pm.coordinates.latitude.toFixed(6)}
                            <span class="coords-label">ÁµåÂ∫¶:</span>${pm.coordinates.longitude.toFixed(6)}
                            ${pm.coordinates.altitude !== null ? `<span class="coords-label">Ê®ôÈ´ò:</span>${pm.coordinates.altitude.toFixed(2)}m` : ''}
                        </div>
                    ` : '<div class="placemark-coords">Â∫ßÊ®ô„Å™„Åó</div>'}
                </div>
            `).join('');

            containerEl.innerHTML = html;
        }

        function showLoading() {
            results.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                </div>
            `;
        }

        function showError(message) {
            results.innerHTML = `<div class="error"><strong>„Ç®„É©„Éº:</strong> ${escapeHtml(message)}</div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ÂàùÊúüË°®Á§∫
        renderFileList();

        // „Ç§„Éô„É≥„Éà„Éá„É™„Ç≤„Éº„Ç∑„Éß„É≥: fileList „ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÇíÊçï„Åæ„Åà„Å¶„ÄÅ.file-header „ÇíËµ∑ÁÇπ„Å´Êäò„ÇäÁï≥„Åø„ÇíÂàá„ÇäÊõø„Åà„Çã
        fileListEl.addEventListener('click', (e) => {
            const header = e.target.closest('.file-header');
            if (!header) return;
            // header „ÅÆ id „ÅØ header-<id>„ÄÅÂØæÂøú„Åô„Çã content „ÅÆ id „ÅØ content-<id>
            const headerId = header.id;
            if (!headerId || !headerId.startsWith('header-')) return;
            const contentId = 'content-' + headerId.slice('header-'.length);
            const contentEl = document.getElementById(contentId);
            if (!contentEl) return;
            const isHidden = contentEl.style.display === 'none' || contentEl.style.display === '';
            contentEl.style.display = isHidden ? 'block' : 'none';
        });

        // Ëá™ÂãïË™≠„ÅøËæº„ÅøÔºà„Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇÔºâ
        window.addEventListener('DOMContentLoaded', () => {
            const files = buildFileList();
            if (files.length > 0) {
                loadAndParseFiles(files);
            } else {
                results.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üåê</div><p>Ë™≠„ÅøËæº„ÇÄ„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p></div>`;
            }
        });

        // ÊâãÂãïÊìç‰Ωú
        loadAllButton.addEventListener('click', () => {
            const files = buildFileList();
            if (files.length === 0) {
                showError('Ë™≠„ÅøËæº„ÇÄ„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            loadAndParseFiles(files);
        });

        refreshButton.addEventListener('click', () => {
            renderFileList();
            results.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üåê</div><p>„É™„Çπ„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇËá™ÂãïË™≠„ÅøËæº„Åø„ÇíÂÜçÂÆüË°å„Åó„Åæ„Åô„ÄÇ</p></div>`;
            const files = buildFileList();
            if (files.length > 0) loadAndParseFiles(files);
        });
    </script>
</body>
</html>
