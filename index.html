<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>函館市災害受援拠点地図</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet Omnivore for KML support -->
    <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    <!-- Google Material Symbols (outlined) -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    
    <style>
        :root {
            --header-height: 64px; /* ヘッダーの高さ（必要に応じて調整） */
        }
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        /* ヘッダー領域を固定表示し、地図はヘッダー分だけ下に余白を取る */
        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            z-index: 1100;
            /* モバイルでのタッチイベントを適切に処理 */
            touch-action: manipulation;
            pointer-events: auto;
        }

        .site-header .title-wrap {
            flex: 1;
            min-width: 0; /* flex要素のオーバーフロー防止 */
            margin-right: 8px;
        }

        .site-header .title-wrap h1 {
            margin: 0;
            font-size: 18px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .site-header .title-wrap p {
            margin: 0;
            font-size: 12px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #map {
            width: 100%;
            height: calc(100vh - var(--header-height));
            margin-top: var(--header-height);
            touch-action: pan-x pan-y; /* 地図のパンは許可、ダブルタップズームは制限 */
        }
        
        /* トグルボタン（モバイルのみ表示） */
        .toggle-button {
            display: none;
            background: white;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: normal;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0; /* ボタンが縮小しないようにする */
            touch-action: manipulation; /* ダブルタップズーム防止 */
        }
        
        .toggle-button:hover {
            background: #f0f0f0;
        }
            /* Material Symbols をマーカー内で表示するためのスタイル */
            .material-marker {
                display: inline-block;
            }
            .material-symbols-outlined {
                font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
                font-size: 16px;
                line-height: 1;
                vertical-align: middle;
            }
        
        .control-panel {
            position: absolute;
            top: calc(var(--header-height) + 10px);
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 250px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .control-panel h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .control-section {
            margin: 15px 0;
        }
        
        .control-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .control-section input[type="checkbox"] {
            margin-right: 5px;
        }
        
        .control-section input[type="range"] {
            width: 100%;
        }
        
        .opacity-value {
            text-align: right;
            font-size: 12px;
            color: #666;
        }
        
    /* モバイル用のスタイル */
    @media (max-width: 768px) {
            .site-header {
                padding: 0 12px; /* モバイルではパディングを少し減らす */
            }
            
            .site-header .title-wrap h1 {
                font-size: 15px;
            }
            
            .site-header .title-wrap p {
                font-size: 10px;
            }
            
            .toggle-button {
                display: block;
                padding: 6px 10px; /* モバイルではパディングを調整 */
                font-size: 13px;
            }
            
            .control-panel {
                top: calc(var(--header-height) + 10px);
                right: 10px;
                left: 10px;
                min-width: auto;
                transform: translateX(0);
                opacity: 1;
            }
            
            .control-panel.hidden {
                transform: translateX(calc(100% + 20px));
                opacity: 0;
                pointer-events: none;
            }
        }

        /* 折り畳み（コラプシブル）用スタイル (全サイズで有効にする) */
        .collapsible {
            margin-bottom: 8px;
        }

        .collapsible-header {
            width: 100%;
            background: #f8f9ff; /* デフォルトの薄い背景色 */
            border: 1px solid #e6e9f0;
            padding: 8px 10px;
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
            color: #1f2d5a;
        }

        .collapsible-header:hover {
            background: #eef4ff;
        }

        /* セクションごとのカラーカスタム（必要に応じて調整） */
        #coll-mapSettings > .collapsible-header {
            background: linear-gradient(180deg, #eef6ff 0%, #f7fbff 100%);
            border-color: #d7e6ff;
            color: #0b3d91;
        }

        #coll-mapSettings > .collapsible-header:hover {
            background: linear-gradient(180deg, #e6f0ff 0%, #f2f9ff 100%);
        }

        #coll-kmlSettings > .collapsible-header {
            background: linear-gradient(180deg, #f0fff4 0%, #fbfff9 100%);
            border-color: #dff9e6;
            color: #177a3f;
        }

        #coll-kmlSettings > .collapsible-header:hover {
            background: linear-gradient(180deg, #e6ffea 0%, #f8fff2 100%);
        }

        .collapsible-header:focus {
            outline: 2px solid rgba(59,130,246,0.6);
            border-radius: 4px;
        }

        .collapsible-content {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.25s ease, padding 0.25s ease;
        }

        /* open クラスが付くと展開 */
        .collapsible.open .collapsible-content {
            max-height: 60vh; /* 大きなリストでも収まるように制限 */
            padding-top: 8px;
        }

        .collapsible .chev {
            font-size: 14px;
            color: currentColor; /* 親の色に合わせる */
            margin-left: 8px;
            transition: transform 0.2s ease;
            transform-origin: center;
        }

        .collapsible.open .chev {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <div class="site-header" role="banner">
        <div class="title-wrap">
            <h1>函館市災害受援拠点地図</h1>
            <p>Disaster Relief Activity Base Map</p>
        </div>
        <!-- モバイル用トグルボタン -->
        <button class="toggle-button" id="toggleButton">地図詳細</button>
    </div>
    <div id="map"></div>
    
    <div class="control-panel hidden" id="controlPanel">
        <!-- 地図設定セクション（折り畳み可能） -->
        <div class="collapsible" id="coll-mapSettings">
            <button class="collapsible-header" type="button" aria-expanded="true" aria-controls="mapSettingsContent">
                <span>地図設定</span>
                <span class="chev">▾</span>
            </button>
            <div class="collapsible-content" id="mapSettingsContent">
                <div class="control-section">
                    <label>ベースマップ:</label>
                    <label>
                        <input type="radio" name="basemap" value="osm" checked>
                        OpenStreetMap
                    </label>
                    <label>
                        <input type="radio" name="basemap" value="gsi">
                        国土地理院地図
                    </label>
                </div>

                <div class="control-section">
                    <label>
                        <input type="checkbox" id="tsunamiToggle" checked>
                        津波ハザードマップ表示
                    </label>
                </div>

                <div class="control-section">
                    <label>
                        <input type="checkbox" id="dosekiToggle">
                        土石流警戒区域表示
                    </label>
                </div>

                <div class="control-section">
                    <label>
                        <input type="checkbox" id="kyukeishaToggle">
                        急傾斜地警戒区域表示
                    </label>
                </div>

                <div class="control-section">
                    <label>
                        <input type="checkbox" id="jisuberiToggle">
                        地すべり警戒区域表示
                    </label>
                </div>

                <div class="control-section">
                    <label for="opacitySlider">透過率:</label>
                    <input type="range" id="opacitySlider" min="0" max="100" value="70">
                    <div class="opacity-value" id="opacityValue">70%</div>
                </div>
            </div>
        </div>

        <!-- KML レイヤーセクション（折り畳み可能） -->
        <div class="collapsible" id="coll-kmlSettings">
            <button class="collapsible-header" type="button" aria-expanded="false" aria-controls="kmlSettingsContent">
                <span>KMLレイヤー</span>
                <span class="chev">▸</span>
            </button>
            <div class="collapsible-content" id="kmlSettingsContent">
                <div class="control-section">
                    <div id="kmlFileList" style="margin-left: 0; margin-top: 5px;">
                        <small style="color: #666;">読み込み中...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- トグルボタンの初期化（Leafletより先に実行） -->
    <script>
        // トグルボタンの機能（モバイル用）および折り畳み初期化
        const toggleButton = document.getElementById('toggleButton');
        const controlPanel = document.getElementById('controlPanel');

        // 折り畳みの状態を設定するユーティリティ
        function setCollapsibleState(key, open) {
            const coll = document.getElementById('coll-' + key);
            if (!coll) return;
            const header = coll.querySelector('.collapsible-header');
            const chevron = header.querySelector('.chev');
            if (open) {
                coll.classList.add('open');
                header.setAttribute('aria-expanded', 'true');
                if (chevron) chevron.textContent = '▾';
            } else {
                coll.classList.remove('open');
                header.setAttribute('aria-expanded', 'false');
                if (chevron) chevron.textContent = '▸';
            }
        }

        // 各折り畳みヘッダにクリック/キー操作を追加
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    const parent = header.parentNode;
                    const open = !parent.classList.contains('open');
                    const key = parent.id.replace('coll-', '');
                    setCollapsibleState(key, open);
                });

                header.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        header.click();
                    }
                });
            });
        });

        toggleButton.addEventListener('click', () => {
            controlPanel.classList.toggle('hidden');

            // ボタンのテキストを変更
            if (controlPanel.classList.contains('hidden')) {
                toggleButton.textContent = '地図詳細';
            } else {
                toggleButton.textContent = '✕ 閉じる';
            }
        });

        // 画面サイズに応じてコントロールパネルと折り畳みの初期状態を設定
        function checkScreenSize() {
            if (window.innerWidth > 768) {
                controlPanel.classList.remove('hidden');
                toggleButton.textContent = '地図詳細';
                // デスクトップでは両方展開
                setCollapsibleState('mapSettings', true);
                setCollapsibleState('kmlSettings', true);
            } else {
                // モバイルではコントロールは隠し、両方を折り畳む
                controlPanel.classList.add('hidden');
                toggleButton.textContent = '地図詳細';
                setCollapsibleState('mapSettings', false);
                setCollapsibleState('kmlSettings', false);
            }
        }

        // 画面サイズ変更時にチェック
        window.addEventListener('resize', checkScreenSize);
        // DOMContentLoaded で折り畳みの初期化とチェックを実行
        document.addEventListener('DOMContentLoaded', () => {
            checkScreenSize();
        });
    </script>
    
    <script>
        // 地図の初期化（函館市）
        const map = L.map('map').setView([41.7688, 140.7288], 12);
        
        // OpenStreetMapタイルレイヤー
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // 国土地理院タイルレイヤー
        const gsiLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
            attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',
            maxZoom: 18
        });
        
        // 津波ハザードマップオーバーレイ
        const tsunamiLayer = L.tileLayer('https://disaportaldata.gsi.go.jp/raster/04_tsunami_newlegend_pref_data/01/{z}/{x}/{y}.png', {
            attribution: '<a href="https://disaportaldata.gsi.go.jp/">ハザードマップポータルサイト</a>',
            opacity: 0.7,
            maxZoom: 18
        }).addTo(map);
        
        // 土石流警戒区域オーバーレイ
        const dosekiLayer = L.tileLayer('https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki_data/01/{z}/{x}/{y}.png', {
            attribution: '<a href="https://disaportaldata.gsi.go.jp/">ハザードマップポータルサイト</a>',
            opacity: 0.7,
            maxZoom: 18
        });
        
        // 急傾斜地警戒区域オーバーレイ
        const kyukeishaLayer = L.tileLayer('https://disaportaldata.gsi.go.jp/raster/05_kyukeishakeikaikuiki_data/01/{z}/{x}/{y}.png', {
            attribution: '<a href="https://disaportaldata.gsi.go.jp/">ハザードマップポータルサイト</a>',
            opacity: 0.7,
            maxZoom: 18
        });
        
        // 地すべり警戒区域オーバーレイ
        const jisuberiLayer = L.tileLayer('https://disaportaldata.gsi.go.jp/raster/05_jisuberikeikaikuiki_data/01/{z}/{x}/{y}.png', {
            attribution: '<a href="https://disaportaldata.gsi.go.jp/">ハザードマップポータルサイト</a>',
            opacity: 0.7,
            maxZoom: 18
        });
        
        // オーバーレイレイヤーの参照配列
        const overlayLayers = [
            { layer: tsunamiLayer, toggle: null },
            { layer: dosekiLayer, toggle: null },
            { layer: kyukeishaLayer, toggle: null },
            { layer: jisuberiLayer, toggle: null }
        ];
        
        // ベースマップ切り替え
        const basemapRadios = document.querySelectorAll('input[name="basemap"]');
        basemapRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                // 現在表示されているオーバーレイレイヤーを特定
                const activeOverlays = overlayLayers.filter(ol => map.hasLayer(ol.layer));
                
                // 表示中のオーバーレイレイヤーを一時的に削除
                activeOverlays.forEach(ol => map.removeLayer(ol.layer));
                
                // ベースマップを切り替え
                if (e.target.value === 'osm') {
                    map.removeLayer(gsiLayer);
                    map.addLayer(osmLayer);
                } else {
                    map.removeLayer(osmLayer);
                    map.addLayer(gsiLayer);
                }
                
                // オーバーレイレイヤーを再追加（ベースマップの上に表示）
                activeOverlays.forEach(ol => map.addLayer(ol.layer));
            });
        });
        
        // 津波レイヤーの表示/非表示切り替え
        const tsunamiToggle = document.getElementById('tsunamiToggle');
        tsunamiToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(tsunamiLayer);
            } else {
                map.removeLayer(tsunamiLayer);
            }
        });
        
        // 土石流レイヤーの表示/非表示切り替え
        const dosekiToggle = document.getElementById('dosekiToggle');
        dosekiToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(dosekiLayer);
            } else {
                map.removeLayer(dosekiLayer);
            }
        });
        
        // 急傾斜地レイヤーの表示/非表示切り替え
        const kyukeishaToggle = document.getElementById('kyukeishaToggle');
        kyukeishaToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(kyukeishaLayer);
            } else {
                map.removeLayer(kyukeishaLayer);
            }
        });
        
        // 地すべりレイヤーの表示/非表示切り替え
        const jisuberiToggle = document.getElementById('jisuberiToggle');
        jisuberiToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(jisuberiLayer);
            } else {
                map.removeLayer(jisuberiLayer);
            }
        });
        
        // 透過率調整
        const opacitySlider = document.getElementById('opacitySlider');
        const opacityValue = document.getElementById('opacityValue');
        opacitySlider.addEventListener('input', (e) => {
            const opacity = e.target.value / 100;
            tsunamiLayer.setOpacity(opacity);
            dosekiLayer.setOpacity(opacity);
            kyukeishaLayer.setOpacity(opacity);
            jisuberiLayer.setOpacity(opacity);
            opacityValue.textContent = e.target.value + '%';
        });
        
        // KMLレイヤーの管理
        const kmlLayers = [];
        
        // KMLレイヤーごとのマーカー色定義
        const markerColors = [
            '#e74c3c', // 赤
            '#3498db', // 青
            '#2ecc71', // 緑
            '#f39c12', // オレンジ
            '#9b59b6', // 紫
            '#1abc9c', // ティール
            '#e67e22', // ダークオレンジ
            '#95a5a6'  // グレー
        ];
        
        // カスタムマーカーアイコンを生成する関数 (Material Icon 名と色を受け取る)
        function createColoredIcon(iconName, color) {
            // 円形バックとアイコンを組み合わせた HTML
            const html = `
                <div style="position: relative; width: 30px; height: 30px;">
                    <div style="
                        background-color: ${color};
                        width: 26px;
                        height: 26px;
                        border-radius: 50%;
                        border: 2px solid white;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        display:flex; align-items:center; justify-content:center;">
                        <span class=\"material-symbols-outlined material-marker\">${iconName}</span>
                    </div>
                </div>`;

            return L.divIcon({
                className: 'custom-marker',
                html: html,
                iconSize: [30, 30],
                iconAnchor: [15, 30],
                popupAnchor: [0, -30]
            });
        }
        
        // KMLファイルのリストをグループ化して定義
        // '消防水利グループ' : 防火水槽、地上式、地下式（ズーム時のみ表示）
        // '受援情報グループ' : その他
        const kmlGroups = {
            shoubou: {
                title: '消防水利（ズーム時のみ表示）',
                files: [
                    'kml/防火水槽.kml',
                    'kml/地上式.kml',
                    'kml/地下式.kml'
                ],
                layerRefs: [], // 読み込んだレイヤ参照を格納
                visibleByUser: false // ユーザがグループを有効化しているか
            },
            support: {
                title: '受援情報',
                files: [
                    'kml/拠点【航空部隊】.kml',
                    'kml/拠点【地上部隊】.kml',
                    'kml/宿営可能地.kml',
                    'kml/前進拠点.kml',
                    'kml/ヘリ離発着.kml',
                    'kml/医療機関.kml',
                    'kml/給油【航空部隊】.kml',
                    'kml/給油【地上部隊】.kml'
                ],
                layerRefs: [],
                // 初期表示で受援情報は表示しておく
                visibleByUser: true
            }
        };
        
        function loadKMLFiles() {
            const kmlFileList = document.getElementById('kmlFileList');
            kmlFileList.innerHTML = '';

            // グループごとにUIの見出しとON/OFF を作る
            Object.keys(kmlGroups).forEach((groupKey, groupIdx) => {
                const group = kmlGroups[groupKey];

                // グループ見出しとトグルチェックボックス
                const groupLabel = document.createElement('div');
                groupLabel.style.marginBottom = '8px';
                groupLabel.style.fontWeight = 'bold';

                const groupCheckbox = document.createElement('input');
                groupCheckbox.type = 'checkbox';
                groupCheckbox.checked = group.visibleByUser;
                groupCheckbox.id = `kml-group-${groupKey}`;
                groupCheckbox.style.marginRight = '6px';

                groupCheckbox.addEventListener('change', (e) => {
                    const checked = e.target.checked;
                    group.visibleByUser = checked;

                    if (checked) {
                        // 親をONにしたときは子を一括でONにする（ユーザ希望の一括ON）
                        kmlLayers.forEach((entry, entryIdx) => {
                            if (entry.group === groupKey) {
                                const childCheckbox = document.getElementById(`kml-${entryIdx}`);
                                if (childCheckbox) childCheckbox.checked = true;
                                entry.visible = true;
                            }
                        });
                        // ON の場合はズーム条件と個別表示状態に従い追加
                        updateGroupVisibility(groupKey);
                    } else {
                        // 親をOFFにしたときは、そのグループに属する全ての子をOFFにする
                        kmlLayers.forEach((entry, entryIdx) => {
                            if (entry.group === groupKey) {
                                const childCheckbox = document.getElementById(`kml-${entryIdx}`);
                                if (childCheckbox) childCheckbox.checked = false;
                                entry.visible = false;
                                // 地図上に存在すれば削除
                                if (map.hasLayer(entry.layer)) map.removeLayer(entry.layer);
                            }
                        });
                    }
                });

                const titleNode = document.createTextNode(group.title);
                groupLabel.appendChild(groupCheckbox);
                groupLabel.appendChild(titleNode);
                kmlFileList.appendChild(groupLabel);

                // 各ファイルを個別に作成
                group.files.forEach((file, idx) => {
                    const globalIndex = kmlLayers.length; // 一意のインデックス
                    const fileName = file.split('/').pop().replace('.kml', '');
                    const markerColor = markerColors[globalIndex % markerColors.length];

                    // KMLごとにアイコン名を割り当てるマッピング（必要に応じて追加/変更）
                    const iconNameMap = {
                        '防火水槽': 'crop_square',
                        '地上式': 'fire_hydrant',
                        '地下式': 'poker_chip',
                        '拠点【航空部隊】': 'flight',
                        '拠点【地上部隊】': 'fire_truck',
                        '宿営可能地': 'hotel',
                        '前進拠点': 'flag',
                        'ヘリ離発着': 'helicopter',
                        '医療機関': 'local_hospital',
                        '給油【航空部隊】': 'local_gas_station',
                        '給油【地上部隊】': 'local_gas_station'
                    };

                    // KMLごとに色を割り当てるマッピング（必要に応じて変更）
                    const iconColorMap = {
                        '防火水槽': '#498aeb',
                        '地上式': '#ebcb3d',
                        '地下式': '#f58552',
                        '拠点【航空部隊】': '#59b65e',
                        '拠点【地上部隊】': '#6669f7',
                        '宿営可能地': '#f39c12',
                        '前進拠点': '#e67e22',
                        'ヘリ離発着': '#7f8892',
                        '医療機関': '#f56454',
                        '給油【航空部隊】': '#16a085',
                        '給油【地上部隊】': '#2980b9'
                    };

                    const assignedIconName = iconNameMap[fileName] || 'place';
                    const assignedColor = iconColorMap[fileName] || markerColor;

                    const kmlLayer = omnivore.kml(file)
                        .on('ready', function() {
                            console.log(`KMLファイル読み込み完了: ${fileName}`);
                            this.eachLayer(function(layer) {
                                if (layer.setIcon) {
                                    layer.setIcon(createColoredIcon(assignedIconName, assignedColor));
                                }
                                if (layer.feature && layer.feature.properties) {
                                    const props = layer.feature.properties;
                                    let popupContent = '';
                                    if (props.name) popupContent += `<strong>${props.name}</strong><br>`;
                                    if (props.description) popupContent += props.description;
                                    if (popupContent) layer.bindPopup(popupContent);
                                }
                            });
                            // 読み込み完了後にファイルリストにアイコン表示（小さなプレビュー）
                            const checkboxLabel = document.querySelector(`#kml-${globalIndex}`)?.parentNode;
                            if (checkboxLabel) {
                                const iconPreview = document.createElement('span');
                                iconPreview.className = 'material-symbols-outlined';
                                iconPreview.style.marginRight = '6px';
                                iconPreview.textContent = assignedIconName;
                                // 小さめに表示
                                iconPreview.style.fontSize = '14px';
                                iconPreview.style.verticalAlign = 'middle';
                                checkboxLabel.insertBefore(iconPreview, checkboxLabel.firstChild);
                            }
                        })
                        .on('error', function(e) {
                            console.error(`KMLファイル読み込みエラー: ${fileName}`, e);
                        });

                    // レイヤー情報を保存（visible をグループの初期設定に合わせる）
                    kmlLayers.push({ layer: kmlLayer, name: fileName, visible: group.visibleByUser, group: groupKey });
                    group.layerRefs.push(kmlLayer);

                    // チェックボックス（個別）
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.style.marginLeft = '18px';
                    label.style.marginBottom = '4px';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `kml-${globalIndex}`;
                    checkbox.style.marginRight = '6px';
                    // 初期チェック状態は kmlLayers の visible に合わせる
                    checkbox.checked = kmlLayers[globalIndex].visible;

                    // 色インジケーター
                    const colorIndicator = document.createElement('span');
                    colorIndicator.style.display = 'inline-block';
                    colorIndicator.style.width = '12px';
                    colorIndicator.style.height = '12px';
                    colorIndicator.style.backgroundColor = assignedColor;
                    colorIndicator.style.borderRadius = '50%';
                    colorIndicator.style.marginRight = '6px';
                    colorIndicator.style.border = '1px solid #ccc';
                    colorIndicator.style.verticalAlign = 'middle';

                    checkbox.addEventListener('change', (e) => {
                        const idx = globalIndex;
                        if (e.target.checked) {
                            kmlLayers[idx].visible = true;
                            // グループの可視性ルールを尊重して表示
                            updateGroupVisibility(groupKey);
                        } else {
                            kmlLayers[idx].visible = false;
                            map.removeLayer(kmlLayers[idx].layer);
                        }
                    });

                    label.appendChild(checkbox);
                    label.appendChild(colorIndicator);
                    label.appendChild(document.createTextNode(fileName));
                    kmlFileList.appendChild(label);
                });
            });

            // 初期表示ルール適用
            updateAllGroupVisibility();
        }

        // 指定グループの表示更新（ズーム条件とユーザ操作に基づく）
        function updateGroupVisibility(groupKey) {
            const group = kmlGroups[groupKey];
            const currentZoom = map.getZoom();
            const zoomThreshold = 16; // ここを必要に応じて調整

            const shouldShowByZoom = (groupKey === 'shoubou') ? (currentZoom >= zoomThreshold) : true;

            group.layerRefs.forEach((layerRef, i) => {
                // 対応する kmlLayers エントリを探す
                const entry = kmlLayers.find(k => k.layer === layerRef);
                if (!entry) return;

                // 表示判定: 個別の entry.visible が優先され、ズーム条件を満たす場合に表示
                // 親 group.visibleByUser は一括ON時の利便性に使うが、親がOFFでも子がONなら表示される
                if (entry.visible && shouldShowByZoom) {
                    if (!map.hasLayer(layerRef)) map.addLayer(layerRef);
                } else {
                    if (map.hasLayer(layerRef)) map.removeLayer(layerRef);
                }
            });
        }

        function updateAllGroupVisibility() {
            Object.keys(kmlGroups).forEach(key => updateGroupVisibility(key));
        }

        // 地図のズーム変更時に消防水利グループの表示を切り替える
        map.on('zoomend', () => {
            updateGroupVisibility('shoubou');
        });

        // KMLファイルを読み込む
        loadKMLFiles();
    </script>
</body>
</html>
