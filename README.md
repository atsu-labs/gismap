# gismap

Leaflet を使用した地図表示サイト

## 機能

- **ベースマップの切り替え**

  - OpenStreetMap (OSM)
  - 国土地理院地図

- **ハザードマップオーバーレイ**

  - 津波ハザードマップ
  - 土石流警戒区域
  - 急傾斜地警戒区域
  - 地すべり警戒区域
  - 各レイヤーの表示/非表示の切り替え
  - 透過率（opacity）の調整（0-100%）

- **KML レイヤー表示**

  - `kml/`ディレクトリ内の KML ファイルを読み込んで地図上に表示
  - 各 KML ファイルを個別に表示/非表示の切り替えが可能
  - KML マーカーにポップアップ表示（名前・説明）
  - **各 KML レイヤーごとに異なる色のマーカーアイコンを自動適用**
    - 8 色のカラーパレット（赤、青、緑、オレンジ、紫、ティール、ダークオレンジ、グレー）
    - レイヤー一覧に色インジケーターを表示し、どの色が割り当てられているか一目で確認可能

- **現在地取得機能**（モバイル端末のみ）

  - ブラウザのGeolocation APIを使用して現在地を取得
  - 地図左下の現在地ボタンをタップすると、GPS等で現在地を表示
  - 現在地を地図の中心に移動し、青色のマーカーで表示
  - 位置情報の精度を示す円も表示
  - モバイル画面（768px以下）でのみボタンが表示される

- **初期表示位置**: 函館市

## 使用方法

1. ブラウザで `index.html` を開く
2. 右上のコントロールパネルから以下の操作が可能：
   - ベースマップの選択（OSM または国土地理院）
   - 各種ハザードマップの表示/非表示
     - 津波ハザードマップ
     - 土石流警戒区域
     - 急傾斜地警戒区域
     - 地すべり警戒区域
   - KML レイヤーの個別表示/非表示
   - オーバーレイの透過率調整
3. モバイル端末では、左下の現在地ボタンをタップして現在地を表示可能
   - 初回タップ時に位置情報の使用許可を求められる場合があります
   - 位置情報がオフの場合は、端末の設定で有効にしてください

### KML ファイルの追加方法

1. `kml/`ディレクトリに KML ファイルを配置
2. `js/kml-loader.js`の`kmlGroups`オブジェクトに新しいファイルパスを追加:
   ```javascript
   const kmlGroups = {
     support: {
       title: '受援情報',
       files: [
         'kml/拠点【航空部隊】.kml',
         'kml/拠点【地上部隊】.kml',
         // ...既存のファイル
         'kml/your-file.kml', // 新しいファイルを追加
       ],
       // ...
     }
   };
   ```
3. アイコンと色をカスタマイズする場合は、同じファイル内の`iconNameMap`と`iconColorMap`を編集
4. ブラウザで再読み込みすると自動的に読み込まれ、個別のチェックボックスで制御できます

## データソース

- OpenStreetMap: https://www.openstreetmap.org/
- 国土地理院地図: https://maps.gsi.go.jp/
- 津波ハザードマップ: https://disaportaldata.gsi.go.jp/

## 技術スタック

- Leaflet 1.9.4
- Leaflet-omnivore 0.3.4 (KML/GPX/CSV/GeoJSON パーサー)
- HTML5/CSS3/JavaScript (ES6 Modules)

## プロジェクト構造

```
gismap/
├── index.html              # トップページ
├── map.html                # 地図表示ページ
├── list.html               # 拠点一覧ページ
├── css/                    # スタイルシート
│   ├── common.css          # 共通スタイル
│   ├── map.css             # 地図ページ用スタイル
│   └── list.css            # 一覧ページ用スタイル
├── js/                     # JavaScriptモジュール
│   ├── map.js              # 地図初期化とメイン処理
│   ├── ui-controls.js      # UI制御（トグルボタン、折り畳み等）
│   ├── kml-loader.js       # KMLファイル読み込み処理
│   ├── kml-parser.js       # KMLパース共通ユーティリティ
│   └── list.js             # 一覧ページのメイン処理
└── kml/                    # KMLファイル格納ディレクトリ
    ├── 拠点【航空部隊】.kml
    ├── 拠点【地上部隊】.kml
    └── ...
```

## コードの特徴

- **モジュール化**: 機能ごとにJavaScriptファイルを分離し、ES6モジュールシステムを採用
- **保守性**: 関数を単一責任原則に従って分割し、コメントを日本語で記述
- **可読性**: 定数を明示的に定義し、マジックナンバーを排除
- **再利用性**: KMLパーサーなど共通機能を独立したモジュールとして抽出

## 動作確認 (ローカル)

1. 単にファイルをダブルクリックで開くと一部ブラウザでローカルファイルの読み込み制限により KML が読み込めない場合があります。以下のように簡易 HTTP サーバを使ってください。

   - Python 3 が使える場合（推奨）:

     ```bash
     # カレントディレクトリを /home/atsu/gismap に移動してから実行
     python3 -m http.server 8000
     ```

     ブラウザで http://localhost:8000 を開く

   - Node.js がある場合:

     ```bash
     npx http-server -c-1
     ```

2. コントロールパネルの「KML レイヤー」項目に各ファイルが表示され、チェックボックスをオンにすると地図上にマーカーが表示されます。

3. 各 KML ファイルに割り当てられた Material Icon と色は、ファイル読み込み時に自動で適用されます。アイコンが表示されない場合は、ブラウザのコンソールを開いてエラーを確認してください。

4. 変更を加えた場合はブラウザのキャッシュをクリアして再読み込みしてください（Shift+Reload が便利です）。

5. さらにアイコン名のマッピングを追加・変更したい場合は、`js/kml-loader.js` 内の `iconNameMap` および `iconColorMap` オブジェクトを編集してください。

## 開発ガイドライン

### コードスタイル

- コメントは日本語で記述
- 関数には JSDoc コメントを付ける
- 定数は大文字のスネークケースで定義（例：`HAKODATE_CENTER`）
- インデントは 4 スペース

### モジュール構成

各JavaScriptモジュールは以下の責務を持ちます：

- `map.js`: 地図の初期化、ベースマップ・オーバーレイレイヤーの管理
- `ui-controls.js`: UI制御（トグルボタン、折り畳みセクション等）
- `kml-loader.js`: KMLファイルの読み込みとマーカー生成
- `kml-parser.js`: KML解析の共通ユーティリティ
- `list.js`: 一覧ページのメイン処理とKMLデータ表示
